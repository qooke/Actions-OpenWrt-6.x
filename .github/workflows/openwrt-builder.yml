name: OpenWrt Builder

on:
  workflow_dispatch:
  repository_dispatch:

env:
  REPO_URL: https://github.com/DragonBluep/openwrt
  REPO_BRANCH: airopi_ax3
  FEEDS_CONF: feeds.conf.default
  CONFIG_FILE: .config
  DIY_P1_SH: diy-part1.sh
  DIY_P2_SH: diy-part2.sh
  TZ: Asia/Hong_Kong

# 只保留最新一次构建
concurrency:
  group: openwrt-builder
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Prepare build environment
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        sudo rm -rf /etc/apt/sources.list.d/*
        sudo apt-get update -qq
        sudo apt-get install -qq \
          build-essential clang flex bison g++ gawk gcc-multilib g++-multilib \
          gettext git libncurses5-dev libssl-dev python3 python3-pyelftools \
          rsync unzip zlib1g-dev file wget curl ccache
        sudo timedatectl set-timezone "$TZ"

        echo "CCACHE_DIR=$HOME/.ccache" >> $GITHUB_ENV
        echo "CCACHE_COMPRESS=true" >> $GITHUB_ENV
        echo "CCACHE_MAXSIZE=5G" >> $GITHUB_ENV

    - name: Restore cache
      uses: actions/cache@v4
      with:
        path: |
          ~/.ccache
          openwrt/dl
        key: openwrt-${{ github.ref }}
        restore-keys: |
          openwrt-

    - name: Clone & customize OpenWrt
      run: |
        git clone --depth=1 $REPO_URL -b $REPO_BRANCH openwrt

        [ -f $FEEDS_CONF ] && mv $FEEDS_CONF openwrt/feeds.conf.default
        chmod +x $DIY_P1_SH $DIY_P2_SH

        cd openwrt
        $GITHUB_WORKSPACE/$DIY_P1_SH
        ./scripts/feeds update -a
        ./scripts/feeds install -a

        [ -f $GITHUB_WORKSPACE/$CONFIG_FILE ] && \
          mv $GITHUB_WORKSPACE/$CONFIG_FILE .config

        $GITHUB_WORKSPACE/$DIY_P2_SH

    - name: Download & build firmware
      id: build
      run: |
        cd openwrt
        make defconfig
        make download -j$(nproc)
        make -j$(nproc)

        DEVICE=$(grep '^CONFIG_TARGET.*DEVICE.*=y' .config | \
          sed -r 's/.*DEVICE_(.*)=y/\1/')

        echo "device_name=_${DEVICE}" >> $GITHUB_OUTPUT
        echo "build_time=$(date +"%Y%m%d%H%M")" >> $GITHUB_OUTPUT

    - name: Prepare firmware directory
      id: firmware
      run: |
        cd openwrt/bin/targets/*/*
        rm -rf packages
        echo "path=$PWD" >> $GITHUB_OUTPUT

    - name: Upload firmware artifact
      uses: actions/upload-artifact@v4
      with:
        name: OpenWrt${{ steps.build.outputs.device_name }}
        path: ${{ steps.firmware.outputs.path }}

    - name: Publish latest release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: latest
        name: OpenWrt Latest Build
        files: ${{ steps.firmware.outputs.path }}/*
        prerelease: false
        draft: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Cleanup old workflow runs
      uses: Mattraks/delete-workflow-runs@v2
      with:
        retain_days: 0
        keep_minimum_runs: 1
        token: ${{ secrets.GITHUB_TOKEN }}
